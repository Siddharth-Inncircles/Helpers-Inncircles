<div class="headerSection">
        <h1 class="page-title">Helpers</h1>
     </div>
<div class="controls-section">
    <div class="filter-controls" (click)="$event.stopPropagation()">
        <div class="filter-icon-container">
            <button class="filter-icon-btn" [class.active]="showSortDialog" (click)="toggleSortDialog($event)"
                title="Sort Options">
                <span class="material-symbols-outlined">
                    swap_vert
                </span>
                <!-- <span class="filter-label">Sort</span> -->
            </button>

            <div class="filter-dialog" *ngIf="showSortDialog"  >
                <div class="dialog-header">
                    <h4>Sort By</h4>
                    <button class="close-btn" (click)="closeAllDialogs()">
                        <mat-icon>close</mat-icon>
                    </button>
                </div>
                <div class="dialog-content">
                    <div class="sort-options">
                        <label *ngFor="let option of sortOptions" class="sort-option"
                            [class.selected]="sortBy === option.value">
                            <input type="radio" [value]="option.value" name="sortBy" [checked]="sortBy === option.value"
                                (change)="applySorting(option.value)">
                            <span>{{ option.label }}</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="filter-icon-container" (click)="$event.stopPropagation()">
            <button class="filter-icon-btn" [class.active]="showServiceOrgDialog" (click)="toggleServiceOrgDialog($event)"
                title="Service & Organization Filter">
                <span class="material-symbols-outlined">
                    filter_alt
                </span>
                <span class="filter-count"
                    *ngIf="(tempSelectedServices.length!=0 || tempSelectedOrganizations.length!=0)">
                    {{ (tempSelectedServices.length!=0 ? 1 : 0) + (tempSelectedOrganizations.length!=0 ? 1 : 0) }}
                </span>
            </button>

            <div class="filter-dialog large" *ngIf="showServiceOrgDialog" (clickOutside)="closeAllDialogs()">
                <div class="dialog-header">
                    <div style="display: flex; justify-content: space-between; min-width: 400px;">
                        <h4>Filter by Service & Organization</h4>
                        <h4 (click)="resetServiceOrgFilters()" style="cursor: pointer; color: var(--primary-color);">
                            Reset</h4>
                    </div>
                    <button class="close-btn" (click)="closeAllDialogs()">
                        <mat-icon>close</mat-icon>
                    </button>
                </div>
                <div class="dialog-content">
                    <div class="filter-section">
                        <h5>Service Type</h5>
                        <div class="search-input">
                            <mat-icon>search</mat-icon>
                            <input type="text" placeholder="Search services..." [(ngModel)]="serviceSearchTerm">
                        </div>
                        <div class="multiselect-container">
                            <div class="multiselect-option select-all">
                                <input type="checkbox" id="selectAllServices" [checked]="isAllServicesSelected()"
                                    [indeterminate]="isSomeServicesSelected()" (change)="toggleAllServices($event)">
                                <label for="selectAllServices">Select All Services</label>
                            </div>
                            <div class="multiselect-option" *ngFor="let option of filteredServiceOptions"
                                [style.display]="option.value === '' ? 'none' : 'flex'">
                                <input type="checkbox" [id]="'service-' + option.value" [value]="option.value"
                                    [checked]="tempSelectedServices.includes(option.value)"
                                    (change)="onServiceSelectionChange(option.value, $event)">
                                <label [for]="'service-' + option.value">{{ option.label }}</label>
                            </div>
                        </div>
                        <div class="selected-count">{{ getSelectedServicesCount() }} service(s) selected</div>
                    </div>

                    <div class="filter-section">
                        <h5>Organization</h5>
                        <div class="search-input">
                            <mat-icon>search</mat-icon>
                            <input type="text" placeholder="Search organizations..."
                                [(ngModel)]="organizationSearchTerm">
                        </div>
                        <div class="multiselect-container">
                            <div class="multiselect-option select-all">
                                <input type="checkbox" id="selectAllOrgs" [checked]="isAllOrganizationsSelected()"
                                    [indeterminate]="isSomeOrganizationsSelected()"
                                    (change)="toggleAllOrganizations($event)">
                                <label for="selectAllOrgs">Select All Organizations</label>
                            </div>
                            <div class="multiselect-option" *ngFor="let option of filteredOrganizationsOptions"
                                [style.display]="option.value === '' ? 'none' : 'flex'">
                                <input type="checkbox" [id]="'org-' + option.value" [value]="option.value"
                                    [checked]="tempSelectedOrganizations.includes(option.value)"
                                    (change)="onOrganizationSelectionChange(option.value, $event)">
                                <label [for]="'org-' + option.value">{{ option.label }}</label>
                            </div>
                        </div>
                        <div class="selected-count">{{ getSelectedOrganizationsCount() }} organization(s) selected</div>
                    </div>

                    <div class="dialog-actions">
                        <button class="btn-secondary" (click)="resetServiceOrgFilters()">
                            Clear All
                        </button>
                        <button class="btn-primary" (click)="applyServiceOrgFilters()">
                            Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="filter-icon-container" (click)="$event.stopPropagation()">
            <button class="filter-icon-btn" [class.active]="showDateDialog || filterDateFrom || filterDateTo"
                (click)="toggleDateDialog($event)" title="Date Range Filter">
                <mat-icon>date_range</mat-icon>
                <span class="filter-count" *ngIf="(filterDateFrom || filterDateTo)">1</span>
            </button>

            <div class="filter-dialog" *ngIf="showDateDialog" (clickOutside)="closeAllDialogs()">
                <div class="dialog-header">
                    <h4>Filter by Date Range</h4>
                    <button class="close-btn" (click)="closeAllDialogs()">
                        <span class="material-symbols-outlined">
                            close
                        </span>
                    </button>
                </div>
                <div class="dialog-content">
                    <div class="date-inputs">
                        <div class="date-input-group">
                            <label>From Date</label>
                            <input type="date" [(ngModel)]="filterDateFrom" class="date-input">
                        </div>
                        <div class="date-input-group">
                            <label>To Date</label>
                            <input type="date" [(ngModel)]="filterDateTo" class="date-input">
                        </div>
                    </div>

                    <div class="dialog-actions">
                        <button class="btn-secondary" (click)="resetDateFilter()">
                            Clear
                        </button>
                        <button class="btn-primary" (click)="applyDateFilter()">
                            Apply Filter
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="search-container">
            <app-custom-input [type]="'text'" [placeholder]="'Name, Employee ID, Phone'" [(ngModel)]="searchTerm"
                (input)="onSearchChange()">
            </app-custom-input>
        </div>

        <p style="color: gray; display: flex; padding-top: 10px;">{{total}} helpers <br>Loaded {{this.filteredHelpers.length}}</p>

        <button class="clear-filters-btn" *ngIf="getActiveFilterCount() > 0 || searchTerm" (click)="clearAllFilters()"
            title="Clear all filters">
            <mat-icon style="font-size: 20px; padding-top: 5px;">clear</mat-icon>
            Clear All
        </button>
        <label></label>
    </div>

    <button class="filter-icon-btn" (click)="saveAsExcel()">
        <mat-icon>arrow_downward</mat-icon>
    </button>
    <div class="add-button-container">
        <app-custom-button label="Add Helper" icon="add" (click)="openAddHelperForm()">
        </app-custom-button>
    </div>
</div>

<!-- <div class="results-summary" *ngIf="filteredHelpers.length !== helpers.length || searchTerm">
    <span>Showing {{ filteredHelpers.length }} of {{ helpers.length }} helpers</span>
    <button class="clear-search-btn" *ngIf="searchTerm" (click)="searchTerm = ''; resetAndFetch()">
        <mat-icon>close</mat-icon>
    </button>
</div> -->



<div class="main-content">
    <!-- Left-SideBar - Helpers List -->
    <div class="helpers-sidebar">
        <div #scrollContainer class="helpers-list" infinite-scroll [infiniteScrollDistance]="2"
            [infiniteScrollThrottle]="150" (scrolled)="onScroll()" [scrollWindow]="false"
            [infiniteScrollContainer]="scrollContainer">
            <div class="helper-item" *ngFor="let helper of filteredHelpers; trackBy:trackByHelper"
                [class.selected]="selectedHelper?.employeeCode === helper.employeeCode" (click)="selectHelper(helper)">
                <div class="helper-avatar">
                    <img *ngIf="helper?.profileImage?.data; else showInitials"
                        [src]="'data:' + helper.profileImage?.mimetype + ';base64,' + helper.profileImage?.data"
                        alt="Profile Image" class="profile-img" />

                    <ng-template #showInitials>
                        <div class="avatar-initials">
                            {{ helper?.name?.slice(0, 2) | uppercase }}
                        </div>
                    </ng-template>
                </div>

                <div class="helper-info">
                    <div class="helper-name"> {{helper.name}} </div>
                    <div class="helper-org"> {{helper.organization}} </div>
                </div>
                <div class="helper-status">
                    <!-- <span class="status-badge" [class]="'status-' + helper.type.toLowerCase()">
                        {{helper.type}}
                    </span> -->
                    <label style="align-items: center; color: grey;">0 Households</label>
                </div>
            </div>
            <div *ngIf="loading">
                Loading...
            </div>
        </div>
    </div>

    <!-- Right Panel - Helper Details -->
    <div class="helper-details-panel">
        <div *ngIf="!selectHelper && !showAddForm" class="no-selection">
            <mat-icon class="large-icon">person_search</mat-icon>
            <h3>Select a helper to view details</h3>
            <p>Choose a helper from the list to see their complete information</p>
        </div>

        <!-- Helper Details View -->
        <div *ngIf="selectedHelper && !showAddForm && !isEditing" class="helper-details">
            <div class="details-header">
                <div class="helper-profile">
                    <div class="helper-avatar">
                        <img *ngIf="selectedHelper?.profileImage?.data; else showInitials"
                            [src]="'data:' + selectedHelper.profileImage?.mimetype + ';base64,' + selectedHelper.profileImage?.data"
                            alt="Profile Image" class="profile-img" style="width: 60px; height: 60px; border-radius: 100%; cursor: pointer;"
                            (click)="viewDocument(selectedHelper.profileImage)"/>

                        <ng-template #showInitials>
                            <div class="avatar-initials" 
                            style="width: 60px; height: 60px; font-size: 25px; background-color: #a8ccf7;"
                            >
                                {{ selectedHelper.name.slice(0, 2) | uppercase }}
                            </div>
                        </ng-template>
                    </div>

                    <div class="profile-info">
                        <h2>{{selectedHelper.name}}</h2>
                        <span class="service-badge" [class]="'badge-' + selectedHelper.type.toLowerCase()">
                            {{selectedHelper.type}}
                        </span>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="filter-icon-btn"
                        (click)="router.navigate(['/edit-helper'], { queryParams: { code: selectedHelper.employeeCode } })"
                        style="height: 50px; justify-content: center;">
                        <mat-icon>edit</mat-icon>
                    </button>
                    <button class="filter-icon-btn" (click)="deleteHelper()"
                        style="height: 50px; justify-content: center;">
                        <mat-icon>delete</mat-icon>
                    </button>
                </div>
            </div>

            <div class="details-content">
                <div class="detail-section">
                    <h3>EMPLOYEE ID</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Identification Card</label>
                            <span (click)="showIdCard(selectedHelper)"
                                style="color: var(--primary-color); cursor: pointer; display: flex; align-items: center; padding-top: 2px;"><mat-icon>remove_red_eye</mat-icon>
                                View</span>
                        </div>
                        <div class="detail-item">
                            <label>Employee Code</label>
                            <span class="detail-value">{{selectedHelper.employeeCode}}</span>
                        </div>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>PERSONAL DETAILS</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Gender</label>
                            <span class="detail-value">{{selectedHelper.gender}}</span>
                        </div>
                        <div class="detail-item">
                            <label>Languages</label>
                            <span class="detail-value">{{selectedHelper.language.join(', ')}}</span>
                        </div>
                        <div class="detail-item">
                            <label>Mobile Number</label>
                            <span class="detail-value">{{selectedHelper.mobileNo}}</span>
                        </div>
                        <div class="detail-item">
                            <label>Email ID</label>
                            <span class="detail-value">{{selectedHelper.emailId || 'Not provided'}}</span>
                        </div>
                        <div class="detail-item">
                            <label>KYC Document</label>
                            <span (click)="viewDocument(selectedHelper.kycDocument)"
                                style="color: var(--primary-color); cursor: pointer; display: flex; align-items: center; padding-top: 2px;"><mat-icon>remove_red_eye</mat-icon>
                                View</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>SERVICE DETAILS</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Type</label>
                            <span class="detail-value">{{selectedHelper.type}}</span>
                        </div>
                        <div class="detail-item">
                            <label>Organization</label>
                            <span class="detail-value">{{selectedHelper.organization }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Joined On</label>
                            <span class="detail-value">{{selectedHelper.joinedOn | date:'mediumDate'}}</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section" *ngIf="selectedHelper.vechileType">
                    <h3>Vehicle Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Vehicle Type</label>
                            <span>{{selectedHelper.vechileType}}</span>
                        </div>
                        <div class="detail-item" *ngIf="selectedHelper.vechileNumber">
                            <label>Vehicle Number</label>
                            <span>{{selectedHelper.vechileNumber}}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>